<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width; initial-scale = 1.0;" />
    <title>Does updating a design document in couchdb cause rebuilding of views?</title>
    <link href="../../style.css" rel="stylesheet"/>

    
  </head>
  <body>
    <header> 
  
  <nav>
    <ul>       
      <li><a href="/">staticshin</a></li>
      <li><a href="/about.html">about</a></li>
      <li><a href="/archives.html">archives</a></li>
      <li title="more" id="more-menu">[...]</li>
    </ul>
  </nav>
  <div class="grid grid-pad nav-grid" style="display:none">
      <div class="col-1-3">
	<h3>Popular Posts</h3>
        <ol>
          <li><a href="/knife-in-the-water">Knife in the water</a></li>
          <li><a href="/understanding-punctuation-in-erlang">Understanding punctuation in erlang</a></li>
          <li><a href="/absurdity-keeler-webwork-and-nis">Absurdity, Keeler, webwork and NIS </a></li>
          <li><a href="/rayman-origins-is-a-silly-little-game">Rayman origins is a silly little game</a></li>
          <li><a href="/dead-man">Dead man</a></li>
        </ol>
      </div>
      <div class="col-1-3">
	<h3>Also on staticshin</h3>
        <a href="/programming">Thoughts on programming</a>
      </div>
      <div class="col-1-3">
      </div>
    </div>
</header>
    
    <div id="post">
      <h1>Does updating a design document in couchdb cause rebuilding of views?</h1>
      <span>Akshat Jiwan Sharma,  Sat Oct 18 2014</span>
      <div class="postBody"><p>The opinions are a bit divided on this question. Some people say "yes every time
you update a design document couchdb rebuilds the views" while others claim "no views are rebuild only when
the map/reduce part of the design document changes". <a href="http://wiki.apache.org/couchdb/HTTP_view_API#Altering.2FChanging_Views">Couchdb's wiki</a> seems to support the first claim</p>
<blockquote>
<p>To change a view or multiple view just alter the design document (see HttpDocumentApi) they are stored in and save it as a new revision. This causes all the views in that design document to be rebuilt on the next access in case the view code has been changed.</p>
</blockquote>
<p>But we will test just to make sure. Couchdb provides us with <code>/{db}/_design/{ddoc}/_info</code> api that</p>
<blockquote>
<p>"Obtains information about the specified design document, including the index, index size and current status of the design document and associated index information."</p>
</blockquote>
<p>It should be fairly easy to test the two claims regarding views and design document updation. So here is what our design document looks like:-</p>
<pre><code>{
   "_id": "_design/test",
   "_rev": "1-d294ec6c760dbfb53a2cac08ac7e43c1",
   "language": "javascript",
   "views": {
       "test_updation": {
           "map": "function(doc) {\nif(doc.roll_no)  emit(doc.roll_no,null);\n}"
       }
   }
}</code></pre>
<p>Let's query the info endpoint:-</p>
<pre><code>curl http://localhost:5984/test_d_doc/_design/test/_info

{
  name: "test",
  view_index: {
    signature: "9e0e76f6b262896317b8a7c3d1c533bd",
    language: "javascript",
    disk_size: 4188,
    data_size: 193,
    update_seq: 3,
    purge_seq: 0,
    updater_running: false,
    compact_running: false,
    waiting_commit: false,
    waiting_clients: 0
  }
}</code></pre>
<p>Make a note of the signature field. Now let us update a design document by say adding a show function? Our new design document looks like:-</p>
<pre><code>{
  _id: "_design/test",
  _rev: "2-2bb1be47ebed5d6f43699f0c83b79d91",
  language: "javascript",
  views: { test_updation: { map: "function(doc) {\nif(doc.roll_no)  emit(doc.roll_no,null);\n}" } },
  shows: { some_show: "function(doc,req){\n    return \"hello world\";\n}" },
  couchapp: {
    signatures: { },
    objects: { },
    manifest: [
      "language",
      "shows/",
      "shows/some_show.js",
      "views/",
      "views/test_updation/",
      "views/test_updation/map.js"
    ]
  }
}</code></pre>
<p>Now let us check for the view signature again</p>
<pre><code>curl http://localhost:5984/test_d_doc/_design/test/_info

{
  name: "test",
  view_index: {
    signature: "9e0e76f6b262896317b8a7c3d1c533bd",
    language: "javascript",
    disk_size: 4188,
    data_size: 193,
    update_seq: 3,
    purge_seq: 0,
    updater_running: false,
    compact_running: false,
    waiting_commit: false,
    waiting_clients: 0
  }
}</code></pre>
<p>As you can see the view signature for the updated design document is exactly the same as the signature before. Now lets check the database directory and the view files that are stored in it. My database dir is at <code>/usr/local/var/lib/couchdb</code> and the view which we are testing is stored in <code>/usr/local/var/lib/couchdb/.test_d_doc_design/mrview/</code> and sure enough there is a view file named 9e0e76f6b262896317b8a7c3d1c533bd.view</p>
<p>Now let us update the view function and check out the view signature. Here is what our design document looks now</p>
<pre><code>{
  _id: "_design/test",
  _rev: "3-e50012d5a2ad7ff96fc4da950175b292",
  language: "javascript",
  views: { test_updation: { map: "function(doc) {\nif(doc.roll_no)  emit(doc.roll_no,doc);\n}" } },
  shows: { some_show: "function(doc,req){\n    return \"hello world\";\n}" },
  couchapp: {
    signatures: { },
    objects: { },
    manifest: [
      "language",
      "shows/",
      "shows/some_show.js",
      "views/",
      "views/test_updation/",
      "views/test_updation/map.js"
    ]
  }
}</code></pre>
<p>and the info:-</p>
<pre><code>{
  name: "test",
  view_index: {
    signature: "ef12fccd479fa831d87abb63b023844b",
    language: "javascript",
    disk_size: 51,
    data_size: 0,
    update_seq: 0,
    purge_seq: 0,
    updater_running: false,
    compact_running: false,
    waiting_commit: false,
    waiting_clients: 0
  }
}</code></pre>
<p>Aha! the signature has changed. Now lets checkout the view files..... and yes  we have ef12fccd479fa831d87abb63b023844b.view in the database directory.</p>
<h3>Conclusion</h3>
<p>The map reduce views are stored in the a file which is named after the <code>md5</code> hash of the <strong>content of all the views</strong> in the design document. An index rebuild occurs only if the content of the view changes. A change in the content of design document has no effect on the view rebuilding.</p>
<p>So hopefully this will clear some confusion about couchdb views and design documents. If you liked this article you will also like <a href="http://www.staticshin.com/programming/caching-in-couchdb/">caching in couchdb</a>, <a href="http://www.staticshin.com/programming/easy-user-accounts-management-with-couchdb/">easy user accounts management in couchdb</a> and the <a href="http://blog.couchdb.org">official couchdb blog</a></p>
<p>Until next time :)</p>
</div>
    </div>

    <div id="disqus_thread"></div>
    <hr>
<footer>
    <h1>Thank you for reading</h1>
</footer>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
<div>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'staticshin'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function ()
  {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37138783-1']);
  _gaq.push(['_trackPageview']);

  (function ()
  {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
 <script src="../../staticshin.js"> </script>
 
  </body>

</html>
