<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Thoughts on indexed db</title>
    <link href="../style.css" rel="stylesheet"/>
  </head>
  <body>
<header>{<a href="/">staticshin</a>,<a href="/about.html">about</a>,<a href="/archives.html">archives</a>}<header>
    
    <div id="post">
      <h1>Thoughts on indexed db</h1>
      <span>Akshat Jiwan Sharma,  Fri Jan 24 2014</span>
      <div class="postBody"><p>Topics discussed in this article </p>
<ol>
<li>Limitations of local storage.</li>
<li>Object stores in indexed db</li>
<li>Indices in indexed db</li>
<li>Cursors.</li>
<li>Shortcomings of indexed db.</li>
</ol>
<p>If you want to learn how to code an application with it then check out these excellent guides on <a href="https://developer.mozilla.org/en/docs/IndexedDB/Using_IndexedDB">mdn</a> and <a href="http://net.tutsplus.com/tutorials/javascript-ajax/working-with-indexeddb/">nettuts</a></p>
<p>While working on my <a href="http://www.wrinq.com/">latest  project</a> I got a chance to try my hand at indexed db. My previous experience of client side storage was limited to the local storage api. Local storage was good but it suffered from one serious shortcoming , you could only store strings in it. Maybe "shortcoming" is not the right word to use here and it could be that local storage was designed to be that way but this requirement essentially makes manipulating your data cumbersome. It has no efficient query mechanism. The only way that you can retrieve data is by it's key. No matter how cleverly you design your keys sooner or later you will encounter a situation where you will feel that it just falls short and reach the inevitable conclusion that local storage is good only for storing tiny data like say user preferences etc, which is a shame considering that it is widely implemented across all the browsers.  </p>
<p>Indexed db, on the other hand is a lot more exciting. First it allows you to store any javascript object.  There is no need to stringify before storing and parsing after retrieving your data. A simple feature like this makes working with client side storage a lot more pleasant. </p>
<p>Indexed db saves all your data in 'stores'. A store in indexed db is like a table in sql databases.  There can be more than one store in a database. The data is still saved in the form of key value pairs just like in local storage. The value can have any structure. A key can either be generated by a key generator (automatically) , supplied manually or it can be supplied as a key path. A key path as the name suggests defines the path within the value object from where it is to be extracted. Any combination of the above two ways can be used as long as a key within a given store is unique. Let us look at an example.</p>
<p>Suppose you have a simple javascript object <code>{name:"akshat", meta: {email:"akshat_fullmetal@yahoo.co.in"}}</code> that you need to persist . There are a couple ways to do it in the indexed db</p>
<ul>
<li>1: {name:"akshat", meta: {email:"akshat_fullmetal@yahoo.co.in"}}</li>
<li>"hello" : {name:"akshat", meta: {email:"akshat_fullmetal@yahoo.co.in"}}</li>
<li>"akshat_fullmetal@yahoo.co.in" : {name:"akshat", meta: {email:"akshat_fullmetal@yahoo.co.in"}}</li>
</ul>
<p>The first approach uses an auto generated key. To keep the values unique these keys are incremented automatically. Every following key will have a value greater than 1. </p>
<p>The second approach supplies a key manually. Here it becomes the responsibility of the programmer to ensure that no two keys are same within the store. </p>
<p>In the third approach we are using a key path <code>meta.email</code> to get the key from the value it stores. This can be a good strategy if you can ensure that one of the values in the object will always be unique. </p>
<p>The keys can be an empty string, an array, a date or even a javascript object. So the takeaway from this is that you can use any way to create keys within a store as long as it is ensured that they will be unique to that store.</p>
<p>For any object store you can create one or more indexes. Indexes allow you to search for your data by value. Time for another example. Suppose you have the following data in your database </p>
<pre><code>{name:"akshat", meta: {profile:"gamer"}}
{name:"jiwan", meta: {profile:"writer"}}
{name:"sharma", meta: {profile:"gamer"}}
{name:"less", meta: {profile:"musician"}}
{name:"dez", meta: {profile:""}}</code></pre>
<p>Suppose we wanted to find the people by their profile. To do this we create an index on the store with the key path as <code>meta.profile</code>. Within the index all of your data will be sorted by the key like:</p>
<pre><code>"gamer": {name:"akshat", meta: {profile:"gamer"}}
"writer" : {name:"jiwan", meta: {profile:"writer"}}
"gamer": {name:"sharma", meta: {profile:"gamer"}}
"musician":{name:"less", meta: {profile:"musician"}}
" ": {name:"dez", meta: {profile:""}}</code></pre>
<p>In an index a key can be empty or non unique. However if you want you can supply a unique constraint at the time of index creation.</p>
<p>Another cool thing about index db is that it is transactional in nature (all of the transactions are asynchronous) which ensures that integrity of the data is intact at all times. The api is very similar to the ajax api. You issue a request and the result is available in  it's call back.  You can query directly from the store to get the value back for the queried key. However to query from the index you need a cursor. </p>
<p>A cursor is simply an iterator that will walk through the elements of the index for as long as you want it to. Consider the case where we need to find the gamer "akshat"  . Now we don't know with what key he has been stored in the database so we will just search him from the index. Here are the steps we need to take.</p>
<ol>
<li>Create a cursor on the index "profile"</li>
<li>Check the value returned by the cursor.</li>
<li>if(!value.name === "akshat") continue cursor; else return value </li>
</ol>
<p>And that's it. The only thing to remember here is that just like everything else the code for cursor will run inside a callback. </p>
<p>The cursor has some other interesting properties as well. First you can specify the direction the cursor starts reading from. By default the direction of cursor is from the beginning and it starts reading ahead. 'prev' starts the cursor from the end of the index and reads behind. You can also skip the cursor by an integer value by using <code>cursor.advance(int)</code> which will make the cursor start from that value. It is important to note that cursor only skips ahead, that is in the forward direction. No point trying to skip it back (I lost a few hours trying to do that)</p>
<p>Indexed db is schema less. But the method to upgrade schema or add new stores is really painful. You have to rely on <code>onupgradeneeded</code> event and it can be a hassle to track what client needs update. So if you have shipped your application all the changes to the database will have to be made through the upgrade event. This can be a bit of a hassle since a part of your database definition is in one event and another part is in an entirely different event. </p>
<p>My overall experience with indexed db has been quite positive. It is a bit saddening that it is not supported fully in all the browsers (safari,android) but I am willing to bet on it. My <a href="http://www.wrinq.com">new project</a> is based heavily on indexed db so I hope that it gains better adoption soon. I will be sharing some tips like pagination with indexed db in the coming posts so stay tuned.</p>
</div>
    </div>

    <div id="disqus_thread"></div>
    <hr>
    <span>
        <a href="/about.html">about</a>
        <a href="/archives.html">archives</a>
    </span>
    <noscript>
      Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
<div>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'staticshin'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function ()
  {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37138783-1']);
  _gaq.push(['_trackPageview']);

  (function ()
  {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
  </body>

</html>
